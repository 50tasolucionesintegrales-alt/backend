<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{titulo}}</title>
  <style>
    :root { --ink:#111; --line:#c9ced8; --thead:#5b3ca5; --theadText:#fff; }
    @page { size: Letter; margin:0; }
    body { font-family: Arial, Helvetica, sans-serif; font-size:12px; color:var(--ink); }
    .bg-page { position: fixed; inset:0; z-index:-1; pointer-events:none; }
    .bg-page img { width:100%; height:100%; object-fit:cover; display:block; }
    .header-space{height:38mm;}
    .fecha{margin:0 13mm 10px; text-align:left; font-weight:700; color:#333;}
    .dest{margin:0 13mm; text-align:right; font-weight:700; line-height:1.45;}
    .intro{margin:10px 13mm 0; line-height:1.55; color:#222;}
    .solicitud{margin:10px 13mm 0; line-height:1.55; color:#222; font-weight:700;}
    .table-wrap{margin:10px 6mm 0;}
    table{width:100%; border-collapse:collapse; table-layout:fixed; background:#fff; border:0.5px solid #000;}
    thead th{background:var(--thead); color:var(--theadText); border:0.5px solid #000; padding:7px 8px; font-size:12px; text-align:left; line-height:1.2;}
    tbody td{border:0.5px solid #000; padding:6px 8px; font-size:12px; line-height:1.35; background:#fff; vertical-align:top;}
    .center{text-align:center;} .right{text-align:right;}
    .w-num{width:10mm;} .w-marca{width:26mm;} .w-cant{width:18mm;} .w-unid{width:18mm;} .w-unit{width:28mm;} .w-sub{width:28mm;}
    .totals-wrap{margin:10px 6mm 0;}
    .totals{margin-left:auto; width:70mm; border-collapse:collapse;}
    .totals td{padding:6px 8px; background:#fff; border-left:1px solid var(--line); border-right:1px solid var(--line);}
    .totals tr:first-child td{border-top:1px solid var(--line);}
    .totals tr:last-child td{border-bottom:1px solid var(--line);}
    .totals .label{font-weight:700;}
    .totals .value{text-align:right;}
    .enletra{margin:8px 18mm 0; text-align:center; font-weight:700;}
    .bottom-row{margin:12px 6mm 0; display:grid; grid-template-columns:1fr 70mm; gap:12mm; align-items:start;}
    .terms .title{font-weight:700; margin-bottom:6px;}
    .terms .content{line-height:1.55;}
    .firma{text-align:center; margin-top:90mm; margin-right:32mm;}
    .firma img{height:24mm; display:inline-block;}
    .pb-before{page-break-before: always;}
  </style>
</head>
<body>

  <div class="bg-page"><img src="assets/emp7.png" alt="membrete"></div>
  <div class="header-space"></div>

  <div class="dest">{{destinatario}}</div>
  <div class="fecha">{{fecha}}</div>
  <div class="solicitud">Cotización <span style="font-weight:600;">{{titulo}} ({{folio}})</span></div>
  <div class="intro">{{{descripcion}}}</div>

  <!-- Tabla con chunk/paginación 5 productos por página -->
  {{#if items.length}}
    {{#each (chunk items 5) as |grupo index|}}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="center w-num">#</th>
              <th>Producto</th>
              <th class="w-marca">Marca</th>
              <th class="center w-cant">Cantidad</th>
              <th class="center w-unid">Unidad</th>
              <th class="right w-unit">Precio Unitario</th>
              <th class="right w-sub">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {{#each grupo}}
            <tr>
              <td class="center w-num">{{inc @index}}</td>
              <td>{{this.nombre}}</td>
              <td class="w-marca">{{this.marca}}</td>
              <td class="center w-cant">{{this.cantidad}}</td>
              <td class="center w-unid">{{this.unidad}}</td>
              <td class="right w-unit">{{money this.unitario}}</td>
              <td class="right w-sub">{{money this.parcial}}</td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>

      {{#if (notLast index ../lastIndex)}}
        <div class="pb-before"></div>
      {{else}}
        <!-- Totales, monto en letra, términos y firma solo al final -->
        <div class="totals-wrap">
          <table class="totals">
            <tr><td class="label">Subtotal</td><td class="value">{{money totales.subtotal}}</td></tr>
            <tr><td class="label">I.V.A.</td><td class="value">{{money totales.iva}}</td></tr>
            <tr><td class="label">Importe Total</td><td class="value">{{money totales.total}}</td></tr>
          </table>
        </div>

        {{#if totalEnLetra}}
        <div class="enletra">(Monto Total en letra: {{totalEnLetra}})</div>
        {{/if}}

        <div class="bottom-row">
          <div class="terms">
            {{#if condiciones}}
              <div class="title">Términos y Condiciones</div>
              <div class="content">{{{condiciones}}}</div>
            {{/if}}
          </div>

          <div class="firma">
            {{#if incluirFirma}}
              <img src="{{firmaUrl}}" alt="firma">
            {{else}}
              <div style="height:100px; margin-left:18px; margin-bottom:8px;"></div>
            {{/if}}
            <div style="font-weight:bold; margin-top:0px; padding-left:25px;">
              {{#if firmanteNombre}}{{firmanteNombre}}{{else}}Responsable de Ventas{{/if}}
            </div>
          </div>
        </div>
      {{/if}}
    {{/each}}
  {{/if}}

</body>
</html>